name: Manually trigger ML Prod job

on:
  workflow_dispatch:

jobs:
  prod-train:
    runs-on: ubuntu-latest
    environment: Prod
    env:
      ENVIRONMENT: ${{vars.ENVIRONMENT}}

    steps:
      - name: Show Enviroment var env
        run: echo "Environment is $ENVIRONMENT "
      - name: Show Enviroment vars.ENVIRONMENT
        run: echo "Environment is ${{ vars.ENVIRONMENT }}"
      - name: Check out repo
        uses: actions/checkout@main
      - name: Install az ml extension
        run: az extension add -n ml -y
      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS}}
      - name: Get the Job
        id: Job
        run: jobname=$(az ml job list --query "sort_by([?experiment_name=='diabetes-prod'].{Name:name,Jobstatus:status,Experiment:experiment_name,Created:creation_context.created_at}, &Created) | [-1].{JobName:Name}" -g rg-mlops-challenge  -w mlw-mlops-challenge -otsv)
